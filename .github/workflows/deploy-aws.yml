name: Deploy Optimization Tool to AWS EC2 Instances

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  EC2_USER: ubuntu
  TOOL_DIR: /home/ubuntu/Optimization-Tool

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
     
      - name: Verify repository content
        run: |
          echo "Current working directory: $(pwd)"
          echo "List of files:" 
          ls -la
          
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" | tr -d '\r' > ~/.ssh/deploy_key.pem
          echo "" >> ~/.ssh/deploy_key.pem
          chmod 600 ~/.ssh/deploy_key.pem
          ssh-keyscan -H ${{ secrets.PUBLIC_INSTANCE_IP }} >> ~/.ssh/known_hosts
          echo "‚úÖ SSH keys configured"

      - name: Test SSH connections
        run: |
          ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no ${{ env.EC2_USER }}@${{ secrets.PUBLIC_INSTANCE_IP }} "echo '‚úÖ Public Instance'"
      - name: Copy files to Public Instance
        run: |
          ssh -i ~/.ssh/deploy_key.pem ${{ env.EC2_USER }}@${{ secrets.PUBLIC_INSTANCE_IP }} "mkdir -p ${{ env.APP_DIR }}"
          rsync -avz -e "ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no" \
          --include='docker/' --include='docker/docker-compose.yml' \
          --include='scripts/' --include='scripts/**' \
          --exclude='*' \
          ./ ${{ env.EC2_USER }}@${{ secrets.PUBLIC_INSTANCE_IP }}:${{ env.APP_DIR }}/

      - name: Setup Public Instance (Docker + Prometheus + Grafana)
        run: |
          PRIVATE_1_IP="${{ secrets.PRIVATE_INSTANCE_1_PRIVATE_IP }}"
          PRIVATE_2_IP="${{ secrets.PRIVATE_INSTANCE_2_PRIVATE_IP }}"
          PRIVATE_3_IP="${{ secrets.PRIVATE_INSTANCE_3_PRIVATE_IP }}"
          ssh -i ~/.ssh/deploy_key.pem ${{ env.EC2_USER }}@${{ secrets.PUBLIC_INSTANCE_IP }} "cd ${{ env.APP_DIR }}/scripts && chmod +x setup_public_instance.sh && ./setup_public_instance.sh $PRIVATE_1_IP $PRIVATE_2_IP ${{ env.APP_DIR }}"

      - name: Deployment Summary
        if: always()
        run: |
          echo "========================================="
          echo "üéâ Deployment Complete"
          echo "========================================="
          echo ""
          echo "üìç PUBLIC INSTANCE: ${{ secrets.PUBLIC_INSTANCE_IP }}"
          echo "   ‚úÖ Docker, Prometheus, Grafana"
          echo "   üìä Prometheus: http://${{ secrets.PUBLIC_INSTANCE_IP }}:9090"
          echo "   üìà Grafana: http://${{ secrets.PUBLIC_INSTANCE_IP }}:3000"
          echo ""

          echo "========================================="

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key.pem
