name: Deploy Application to AWS EC2

on:
  push:
    branches:
      - main
      - development
  workflow_dispatch:

env:
  EC2_USER: ubuntu
  APP_DIR: /home/ubuntu/ga-framework

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup SSH key
        run: |
            set -e  # Exit on error, but we'll handle errors explicitly
    
            mkdir -p ~/.ssh
            echo "‚úÖ SSH directory created"
            
            # Create SSH key with proper formatting
            echo "${{ secrets.EC2_SSH_KEY }}" | tr -d '\r' > ~/.ssh/deploy_key.pem
            echo "" >> ~/.ssh/deploy_key.pem
            chmod 600 ~/.ssh/deploy_key.pem
            echo "‚úÖ SSH key created"
            
            # Verify SSH key format
            echo "üîç Verifying SSH key format..."
            if head -n 1 ~/.ssh/deploy_key.pem | grep -q "BEGIN.*PRIVATE KEY"; then
            echo "‚úÖ Key header looks valid"
            else
            echo "‚ùå Invalid key header"
            head -n 1 ~/.ssh/deploy_key.pem
            exit 1
            fi
            
            if tail -n 2 ~/.ssh/deploy_key.pem | grep -q "END.*PRIVATE KEY"; then
            echo "‚úÖ Key footer looks valid"
            else
            echo "‚ùå Invalid key footer"
            tail -n 2 ~/.ssh/deploy_key.pem
            exit 1
            fi
            
            # Check key permissions
            ls -la ~/.ssh/deploy_key.pem
            
            # Add instances to known_hosts with error handling
            echo "üîç Attempting to scan SSH host keys..."
            
            echo "Scanning PUBLIC_INSTANCE_IP: ${{ secrets.PUBLIC_INSTANCE_IP }}"
            if ssh-keyscan -H ${{ secrets.PUBLIC_INSTANCE_IP }} >> ~/.ssh/known_hosts 2>&1; then
            echo "‚úÖ Public instance key added"
            else
            echo "‚ö†Ô∏è  Warning: Could not reach public instance for key scanning"
            echo "   This may be normal if the instance is not yet accessible"
            fi
            
            echo "Scanning PRIVATE_INSTANCE_1_IP: ${{ secrets.PRIVATE_INSTANCE_1_IP }}"
            if ssh-keyscan -H ${{ secrets.PRIVATE_INSTANCE_1_IP }} >> ~/.ssh/known_hosts 2>&1; then
            echo "‚úÖ Private instance 1 key added"
            else
            echo "‚ö†Ô∏è  Warning: Could not reach private instance 1 for key scanning"
            echo "   This is expected for private instances without public access"
            fi
            
            echo "Scanning PRIVATE_INSTANCE_2_IP: ${{ secrets.PRIVATE_INSTANCE_2_IP }}"
            if ssh-keyscan -H ${{ secrets.PRIVATE_INSTANCE_2_IP }} >> ~/.ssh/known_hosts 2>&1; then
            echo "‚úÖ Private instance 2 key added"
            else
            echo "‚ö†Ô∏è  Warning: Could not reach private instance 2 for key scanning"
            echo "   This is expected for private instances without public access"
            fi
            
            echo "‚úÖ SSH keys configured for all instances"

      - name: Test SSH connections
        run: |
          echo "Testing SSH connections..."
          ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no ${{ env.EC2_USER }}@${{ secrets.PUBLIC_INSTANCE_IP }} "echo '‚úÖ Public Instance connected'"
          ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no ${{ env.EC2_USER }}@${{ secrets.PRIVATE_INSTANCE_1_IP }} "echo '‚úÖ Private Instance 1 connected'"
          ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no ${{ env.EC2_USER }}@${{ secrets.PRIVATE_INSTANCE_2_IP }} "echo '‚úÖ Private Instance 2 connected'"

      # ========================================
      # PUBLIC INSTANCE: Docker + Prometheus
      # ========================================
      - name: Deploy to Public Instance (Docker + Prometheus)
        run: |
          PUBLIC_IP="${{ secrets.PUBLIC_INSTANCE_IP }}"
          PRIVATE_1_IP="${{ secrets.PRIVATE_INSTANCE_1_IP }}"
          PRIVATE_2_IP="${{ secrets.PRIVATE_INSTANCE_2_IP }}"
          
          echo "üöÄ Deploying to Public Instance ($PUBLIC_IP)..."
          
          # Create directory and copy files
          ssh -i ~/.ssh/deploy_key.pem ${{ env.EC2_USER }}@$PUBLIC_IP "mkdir -p ${{ env.APP_DIR }}"
          
          rsync -avz -e "ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no" \
            --exclude '.git' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude '.github' \
            --exclude 'infrastructure/terraform.tfstate*' \
            --exclude 'infrastructure/*.pem' \
            ./ ${{ env.EC2_USER }}@$PUBLIC_IP:${{ env.APP_DIR }}/
          
          echo "‚úÖ Files copied to Public Instance"
          
          # Install Docker and setup monitoring
          ssh -i ~/.ssh/deploy_key.pem ${{ env.EC2_USER }}@$PUBLIC_IP bash << 'ENDSSH'
            cd ${{ env.APP_DIR }}/scripts
            
            # Install Docker
            chmod +x install_docker.sh
            ./install_docker.sh
            
            # Create Docker network for monitoring
            sudo docker network create ${{ env.DOCKER_NETWORK }} || echo "Network already exists"
            
            # Create Prometheus configuration
            mkdir -p ${{ env.APP_DIR }}/monitoring/prometheus
            cat > ${{ env.APP_DIR }}/monitoring/prometheus/prometheus.yml << 'EOF'
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  # Prometheus itself
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # Node Exporter on Private Instance 1
  - job_name: 'node-exporter-private-1'
    static_configs:
      - targets: ['$PRIVATE_1_IP:9100']
        labels:
          instance: 'private-instance-1'

  # Node Exporter on Private Instance 2
  - job_name: 'node-exporter-private-2'
    static_configs:
      - targets: ['$PRIVATE_2_IP:9100']
        labels:
          instance: 'private-instance-2'

  # MySQL Exporter on Private Instance 2
  - job_name: 'mysql-exporter'
    static_configs:
      - targets: ['$PRIVATE_2_IP:9104']
        labels:
          instance: 'private-instance-2-mysql'
EOF
            
            # Start Prometheus with Docker
            sudo docker run -d \
              --name prometheus \
              --network ${{ env.DOCKER_NETWORK }} \
              -p 9090:9090 \
              -v ${{ env.APP_DIR }}/monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml \
              prom/prometheus:latest \
              --config.file=/etc/prometheus/prometheus.yml || echo "Prometheus already running"
            
            # Start Grafana (optional)
            sudo docker run -d \
              --name grafana \
              --network ${{ env.DOCKER_NETWORK }} \
              -p 3000:3000 \
              grafana/grafana:latest || echo "Grafana already running"
            
            echo "‚úÖ Public Instance setup complete"
            echo "üìä Prometheus: http://$PUBLIC_IP:9090"
            echo "üìà Grafana: http://$PUBLIC_IP:3000"
          ENDSSH

      # ========================================
      # PRIVATE INSTANCE 1: Node Exporter
      # ========================================
      - name: Setup Private Instance 1 (Node Exporter)
        run: |
          INSTANCE_IP="${{ secrets.PRIVATE_INSTANCE_1_IP }}"
          
          echo "üöÄ Setting up Private Instance 1 ($INSTANCE_IP)..."
          
          # Create directory and copy files
          ssh -i ~/.ssh/deploy_key.pem ${{ env.EC2_USER }}@$INSTANCE_IP "mkdir -p ${{ env.APP_DIR }}"
          
          rsync -avz -e "ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no" \
            --exclude '.git' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude '.github' \
            ./ ${{ env.EC2_USER }}@$INSTANCE_IP:${{ env.APP_DIR }}/
          
          # Install Node Exporter
          ssh -i ~/.ssh/deploy_key.pem ${{ env.EC2_USER }}@$INSTANCE_IP bash << 'ENDSSH'
            # Download and install Node Exporter
            NODE_EXPORTER_VERSION="1.8.2"
            
            cd /tmp
            wget https://github.com/prometheus/node_exporter/releases/download/v${NODE_EXPORTER_VERSION}/node_exporter-${NODE_EXPORTER_VERSION}.linux-amd64.tar.gz
            tar xvfz node_exporter-${NODE_EXPORTER_VERSION}.linux-amd64.tar.gz
            sudo cp node_exporter-${NODE_EXPORTER_VERSION}.linux-amd64/node_exporter /usr/local/bin/
            sudo chmod +x /usr/local/bin/node_exporter
            
            # Create systemd service
            sudo tee /etc/systemd/system/node_exporter.service > /dev/null << 'EOF'
[Unit]
Description=Node Exporter
After=network.target

[Service]
Type=simple
User=ubuntu
ExecStart=/usr/local/bin/node_exporter

[Install]
WantedBy=multi-user.target
EOF
            
            # Start and enable Node Exporter
            sudo systemctl daemon-reload
            sudo systemctl enable node_exporter
            sudo systemctl restart node_exporter
            
            echo "‚úÖ Node Exporter installed and running on port 9100"
          ENDSSH

      # ========================================
      # PRIVATE INSTANCE 2: MySQL + Exporters + App
      # ========================================
      - name: Setup Private Instance 2 (MySQL + Exporters + Application)
        run: |
          INSTANCE_IP="${{ secrets.PRIVATE_INSTANCE_2_IP }}"
          PUBLIC_IP="${{ secrets.PUBLIC_INSTANCE_IP }}"
          PRIVATE_1_IP="${{ secrets.PRIVATE_INSTANCE_1_IP }}"
          PRIVATE_2_IP="${{ secrets.PRIVATE_INSTANCE_2_IP }}"
          
          echo "üöÄ Setting up Private Instance 2 ($INSTANCE_IP)..."
          
          # Create directory and copy files
          ssh -i ~/.ssh/deploy_key.pem ${{ env.EC2_USER }}@$INSTANCE_IP "mkdir -p ${{ env.APP_DIR }}"
          
          rsync -avz -e "ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no" \
            --exclude '.git' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude '.github' \
            ./ ${{ env.EC2_USER }}@$INSTANCE_IP:${{ env.APP_DIR }}/
          
          # Setup MySQL, Exporters, and Application
          ssh -i ~/.ssh/deploy_key.pem ${{ env.EC2_USER }}@$INSTANCE_IP bash << ENDSSH
            cd ${{ env.APP_DIR }}/scripts
            
            # 1. Install MySQL
            chmod +x install_mysql.sh
            ./install_mysql.sh "$PUBLIC_IP" "$PRIVATE_1_IP" "$PRIVATE_2_IP" "${{ secrets.MYSQL_PASSWORD }}"
            
            # 2. Install Python dependencies for the optimization project
            chmod +x install_dependencies.sh
            ./install_dependencies.sh ${{ env.APP_DIR }}
            
            # 3. Install Node Exporter
            NODE_EXPORTER_VERSION="1.8.2"
            cd /tmp
            wget https://github.com/prometheus/node_exporter/releases/download/v\${NODE_EXPORTER_VERSION}/node_exporter-\${NODE_EXPORTER_VERSION}.linux-amd64.tar.gz
            tar xvfz node_exporter-\${NODE_EXPORTER_VERSION}.linux-amd64.tar.gz
            sudo cp node_exporter-\${NODE_EXPORTER_VERSION}.linux-amd64/node_exporter /usr/local/bin/
            sudo chmod +x /usr/local/bin/node_exporter
            
            # Create Node Exporter service
            sudo tee /etc/systemd/system/node_exporter.service > /dev/null << 'EOF'
[Unit]
Description=Node Exporter
After=network.target

[Service]
Type=simple
User=ubuntu
ExecStart=/usr/local/bin/node_exporter

[Install]
WantedBy=multi-user.target
EOF
            
            sudo systemctl daemon-reload
            sudo systemctl enable node_exporter
            sudo systemctl restart node_exporter
            
            # 4. Install MySQL Exporter
            MYSQL_EXPORTER_VERSION="0.15.1"
            cd /tmp
            wget https://github.com/prometheus/mysqld_exporter/releases/download/v\${MYSQL_EXPORTER_VERSION}/mysqld_exporter-\${MYSQL_EXPORTER_VERSION}.linux-amd64.tar.gz
            tar xvfz mysqld_exporter-\${MYSQL_EXPORTER_VERSION}.linux-amd64.tar.gz
            sudo cp mysqld_exporter-\${MYSQL_EXPORTER_VERSION}.linux-amd64/mysqld_exporter /usr/local/bin/
            sudo chmod +x /usr/local/bin/mysqld_exporter
            
            # Create MySQL Exporter configuration
            sudo tee /etc/.mysqld_exporter.cnf > /dev/null << EOF
[client]
user=ga_app_user
password=${{ secrets.MYSQL_PASSWORD }}
host=localhost
port=3306
EOF
            
            sudo chmod 600 /etc/.mysqld_exporter.cnf
            
            # Create MySQL Exporter service
            sudo tee /etc/systemd/system/mysql_exporter.service > /dev/null << 'EOF'
[Unit]
Description=MySQL Exporter
After=network.target

[Service]
Type=simple
User=ubuntu
ExecStart=/usr/local/bin/mysqld_exporter --config.my-cnf=/etc/.mysqld_exporter.cnf

[Install]
WantedBy=multi-user.target
EOF
            
            sudo systemctl daemon-reload
            sudo systemctl enable mysql_exporter
            sudo systemctl restart mysql_exporter
            
            echo "‚úÖ Private Instance 2 setup complete"
            echo "üìä Node Exporter: $INSTANCE_IP:9100"
            echo "üóÑÔ∏è  MySQL Exporter: $INSTANCE_IP:9104"
            echo "üóÑÔ∏è  MySQL Server: $INSTANCE_IP:3306"
          ENDSSH

      # ========================================
      # Start Optimization Application
      # ========================================
      - name: Start Optimization Application
        run: |
          INSTANCE_IP="${{ secrets.PRIVATE_INSTANCE_2_IP }}"
          
          echo "üöÄ Starting optimization application..."
          
          ssh -i ~/.ssh/deploy_key.pem ${{ env.EC2_USER }}@$INSTANCE_IP bash << 'ENDSSH'
            cd ${{ env.APP_DIR }}/scripts
            chmod +x start_application.sh
            ./start_application.sh ${{ env.APP_DIR }}
          ENDSSH

      # ========================================
      # Health Checks
      # ========================================
      - name: Health Check All Services
        run: |
          echo "üè• Running health checks..."
          
          # Public Instance
          echo "Checking Public Instance..."
          ssh -i ~/.ssh/deploy_key.pem ${{ env.EC2_USER }}@${{ secrets.PUBLIC_INSTANCE_IP }} bash << 'EOF'
            echo "Docker containers:"
            sudo docker ps
            
            echo ""
            echo "Prometheus status:"
            curl -s http://localhost:9090/-/healthy || echo "Prometheus not responding"
          EOF
          
          # Private Instance 1
          echo ""
          echo "Checking Private Instance 1..."
          ssh -i ~/.ssh/deploy_key.pem ${{ env.EC2_USER }}@${{ secrets.PRIVATE_INSTANCE_1_IP }} bash << 'EOF'
            echo "Node Exporter status:"
            systemctl status node_exporter --no-pager | head -5
            curl -s http://localhost:9100/metrics | head -5
          EOF
          
          # Private Instance 2
          echo ""
          echo "Checking Private Instance 2..."
          ssh -i ~/.ssh/deploy_key.pem ${{ env.EC2_USER }}@${{ secrets.PRIVATE_INSTANCE_2_IP }} bash << 'EOF'
            cd ${{ env.APP_DIR }}/scripts
            chmod +x health_check.sh
            ./health_check.sh ${{ env.APP_DIR }}
            
            echo ""
            echo "MySQL status:"
            systemctl status mysql --no-pager | head -5
            
            echo ""
            echo "Node Exporter status:"
            systemctl status node_exporter --no-pager | head -5
            
            echo ""
            echo "MySQL Exporter status:"
            systemctl status mysql_exporter --no-pager | head -5
          EOF

      # ========================================
      # Deployment Summary
      # ========================================
      - name: Deployment Summary
        if: always()
        run: |
          echo "========================================="
          echo "üéâ Deployment Complete"
          echo "========================================="
          echo ""
          echo "üìç PUBLIC INSTANCE: ${{ secrets.PUBLIC_INSTANCE_IP }}"
          echo "   ‚úÖ Docker installed"
          echo "   ‚úÖ Prometheus: http://${{ secrets.PUBLIC_INSTANCE_IP }}:9090"
          echo "   ‚úÖ Grafana: http://${{ secrets.PUBLIC_INSTANCE_IP }}:3000"
          echo ""
          echo "üìç PRIVATE INSTANCE 1: ${{ secrets.PRIVATE_INSTANCE_1_IP }}"
          echo "   ‚úÖ Node Exporter: ${{ secrets.PRIVATE_INSTANCE_1_IP }}:9100"
          echo ""
          echo "üìç PRIVATE INSTANCE 2: ${{ secrets.PRIVATE_INSTANCE_2_IP }}"
          echo "   ‚úÖ MySQL Server: ${{ secrets.PRIVATE_INSTANCE_2_IP }}:3306"
          echo "   ‚úÖ MySQL Exporter: ${{ secrets.PRIVATE_INSTANCE_2_IP }}:9104"
          echo "   ‚úÖ Node Exporter: ${{ secrets.PRIVATE_INSTANCE_2_IP }}:9100"
          echo "   ‚úÖ Optimization Application running"
          echo ""
          echo "========================================="

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key.pem
          echo "‚úÖ Cleanup complete"
